name: Dev Branch Build

on:
  push:
    branches:
      - dev

jobs:
  build-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          # Get current version from Version.cs
          CURRENT_VERSION=$(grep 'AppVersion =' src/Version.cs | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Add build number and dev suffix
          BUILD_NUMBER=${{ github.run_number }}
          DEV_VERSION="$CURRENT_VERSION.$BUILD_NUMBER-dev"

          echo "Dev version: $DEV_VERSION"
          echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Copy Frontend to wwwroot
        run: |
          rm -rf src/wwwroot/assets src/wwwroot/index.html
          mkdir -p src/wwwroot/assets
          cp -r _output/UI/* src/wwwroot/
          echo "Frontend files copied to src/wwwroot:"
          ls -la src/wwwroot/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            sportarr/sportarr:dev
            sportarr/sportarr:${{ steps.version.outputs.version }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
        env:
          BUILDX_NO_DEFAULT_ATTESTATIONS: 1

      - name: Send Discord notification
        if: success()
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_RELEASE_WEBHOOK }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Get the commit that triggered this build
          COMMIT_MSG=$(git log --pretty=format:"%s" -1 | sed 's/"/\\"/g')
          COMMIT_SHA=$(git rev-parse --short HEAD)

          DESCRIPTION="**Development Build**\n• ${COMMIT_MSG}\n\n⚠️ **This is a development build for testing purposes.**\n\n**Docker Installation**\n\`\`\`\ndocker pull sportarr/sportarr:dev\n\`\`\`"

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"Sportarr Dev\",
              \"embeds\": [{
                \"title\": \"Dev Build - ${VERSION}\",
                \"description\": \"$DESCRIPTION\",
                \"color\": 16776960,
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }"
